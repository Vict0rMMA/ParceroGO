<!DOCTYPE html>
<html lang="es">
<head>
    <script src="/static/api-shim.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#FF8C00">
    <title>Pedir - Parcero Go</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        .delivery-layout { max-width: 1200px; margin: 0 auto; padding: 1rem 0 2rem; }
        .content-grid { display: grid; grid-template-columns: 360px 1fr; gap: 2rem; margin-top: 1.5rem; }
        @media (max-width: 900px) { .content-grid { grid-template-columns: 1fr; } }
        .sidebar { background: var(--dark-card); border: 1px solid var(--border-color); border-radius: 18px; padding: 1.5rem; max-height: 75vh; overflow-y: auto; }
        .sidebar h3 { font-size: 1.25rem !important; }
        .main-content { background: var(--dark-card); border: 1px solid var(--border-color); border-radius: 18px; padding: 2rem; min-height: 450px; }
        .business-details-header { margin-bottom: 1.75rem; padding-bottom: 1.25rem; border-bottom: 1px solid var(--border-color); }
        .business-details-header h3 { margin: 0 0 0.5rem 0; color: var(--primary-color); font-size: 1.6rem; font-weight: 700; }
        .business-details-header p { margin: 0; color: var(--text-light); font-size: 1.05rem; }
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.25rem; }
        .product-card-modern { background: var(--darker-card); border-radius: 14px; padding: 1.25rem; border: 1px solid var(--border-color); transition: all 0.2s; cursor: pointer; position: relative; overflow: hidden; }
        .product-card-modern:hover { border-color: var(--primary-color); box-shadow: 0 4px 20px rgba(212,175,55,0.15); }
        .product-card-modern .img-wrap, .product-card-modern > div:first-child { border-radius: 12px; margin-bottom: 0.85rem; }
        .product-card-modern h4 { margin: 0.5rem 0; color: var(--text-dark); font-size: 1.05rem; line-height: 1.35; }
        .product-card-modern .price { color: var(--primary-color); font-weight: 700; font-size: 1.25rem; margin: 0.5rem 0; }
        .product-card-modern .add-btn, .product-card-modern button { padding: 0.75rem 1rem; font-size: 1rem !important; border-radius: 12px; }
        .map-section { margin-top: 2rem; background: var(--dark-card); border: 1px solid var(--border-color); border-radius: 18px; padding: 1.5rem; }
        .map-section h3 { margin: 0 0 1rem 0; color: var(--primary-color); font-size: 1.35rem; }
        #map { height: 420px; width: 100%; border-radius: 14px; }
        .business-card { border-radius: 14px; padding: 1.25rem; margin-bottom: 1rem; border: 2px solid var(--border-color); transition: all 0.2s; background: var(--darker-card); font-size: 1rem; }
        .business-card:hover { border-color: var(--primary-color); }
        #business-details-empty p { font-size: 1.15rem; }
    </style>
</head>
<body>
    <a href="#main" class="skip-link">Saltar al contenido</a>

    <div class="app-shell app-shell--wide">
        <header class="app-header">
            <div class="app-header-row">
                <a href="/" class="app-header-back" aria-label="Volver">‚Äπ</a>
                <a href="/" class="brand-wrap" style="display:flex;align-items:center;flex:1;justify-content:center;text-decoration:none;min-width:0;">
                    <img src="/static/logo.png" alt="Parcero Go" style="height:34px;width:auto;object-fit:contain;" onerror="this.style.display='none';this.nextElementSibling.style.display='inline';">
                    <span class="brand-text-fallback" style="display:none;font-size:1rem;font-weight:700;">Parcero Go</span>
                </a>
                <div class="app-header-address">
                    <span class="addr-text">üìç Calle 39B #109-46, Medell√≠n</span>
                    <span class="chevron">‚åÑ</span>
                </div>
            </div>
            <div class="promo-banner-mini">
                <svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;"><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 11 8.76l1-1.36 1 1.36L15.38 12 17 10.83 14.92 8H20v6z"/></svg>
                ¬°Env√≠o gratis!
            </div>
            <div class="app-search-row">
                <div class="app-search" style="flex: 1;">
                    <svg class="search-icon" viewBox="0 0 24 24" fill="currentColor" style="width:20px;height:20px;"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                    <input type="text" id="search-business" placeholder="Buscar negocio o categor√≠a..." aria-label="Buscar negocios">
                </div>
                <div class="app-header-actions">
                    <a href="/tracking" aria-label="Pedidos">üìã</a>
                    <button type="button" onclick="toggleDeliveryCart()" aria-label="Carrito" class="cart-icon-btn">
                        <svg class="cart-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                        <span class="cart-badge-dot" id="delivery-cart-badge" style="display: none;">0</span>
                    </button>
                </div>
            </div>
        </header>

        <nav class="categories-strip" aria-label="Categor√≠as">
            <div class="categories-strip-inner">
                <a href="/delivery?categoria=super" class="category-chip" data-categoria="super"><div class="icon-wrap">üõí</div><span>S√∫per</span></a>
                <a href="/delivery?categoria=expres" class="category-chip" data-categoria="expres"><div class="icon-wrap">üõçÔ∏è</div><span>Expr√©s</span></a>
                <a href="/delivery?categoria=farmacias" class="category-chip" data-categoria="farmacias"><div class="icon-wrap">üíä</div><span>Farmacias</span></a>
                <a href="/delivery?categoria=panaderia" class="category-chip" data-categoria="panaderia"><div class="icon-wrap">ü•ñ</div><span>Panader√≠a</span></a>
                <a href="/delivery?categoria=restaurantes" class="category-chip" data-categoria="restaurantes"><div class="icon-wrap">üçΩÔ∏è</div><span>Restaurantes</span></a>
                <a href="/delivery?categoria=cafe" class="category-chip" data-categoria="cafe"><div class="icon-wrap">‚òï</div><span>Caf√©</span></a>
            </div>
        </nav>

        <main id="main" class="delivery-layout">
            <div class="content-grid">
                <div class="sidebar">
                    <h3 style="margin: 0 0 1rem 0; color: var(--primary-color); font-size: 1.1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--primary-color);">üè™ Tiendas</h3>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-light); font-size: 0.9rem; margin-bottom: 0.5rem;">
                            <input type="checkbox" id="filter-open"> Abierto ahora
                        </label>
                        <select id="sort-businesses" style="width: 100%; padding: 0.5rem; background: var(--darker-card); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-dark); font-size: 0.9rem;">
                            <option value="name">Orden: Nombre</option>
                            <option value="rating">Orden: Rating</option>
                            <option value="time">Orden: Tiempo entrega</option>
                        </select>
                    </div>
                    <div id="businesses-list"></div>
                </div>

                <div class="main-content">
                    <div id="business-details" style="display: none;">
                        <div class="business-details-header">
                            <h3 id="business-name"></h3>
                            <p id="business-info"></p>
                        </div>
                        <div class="products-grid" id="products-list"></div>
                    </div>
                    <div id="business-details-empty" style="text-align: center; padding: 3rem 1rem; color: var(--text-muted);">
                        <p style="font-size: 1.1rem;">Selecciona una tienda para ver productos</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Elige un negocio de la lista de la izquierda</p>
                    </div>
                </div>
            </div>

            <div class="map-section">
                <h3>üó∫Ô∏è Mapa de Negocios</h3>
                <div id="map"></div>
            </div>
        </main>
    </div>

    <!-- Panel del Carrito -->
    <div id="delivery-cart-sidebar" style="position: fixed; right: -380px; top: 0; width: 380px; max-width: 100vw; height: 100vh; background: var(--dark-card); border-left: 2px solid var(--primary-color); box-shadow: -4px 0 24px rgba(0,0,0,0.3); z-index: 2000; transition: right 0.3s ease; display: flex; flex-direction: column;">
        <div style="padding: 1.25rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: var(--primary-color); font-size: 1.3rem;">üõí Mi Pedido</h2>
            <button type="button" onclick="toggleDeliveryCart()" style="background: none; border: none; color: var(--text-dark); font-size: 1.75rem; cursor: pointer; padding: 0; line-height: 1;">√ó</button>
        </div>
        <div id="delivery-cart-content" style="flex: 1; overflow-y: auto; padding: 1rem;">
            <div id="delivery-cart-empty" style="text-align: center; padding: 2rem 1rem; color: var(--text-muted);">
                <p>Tu pedido est√° vac√≠o</p>
                <p style="font-size: 0.9rem;">Agrega productos para comenzar</p>
            </div>
            <div id="delivery-cart-items"></div>
        </div>
        <div id="delivery-cart-footer" style="display: none; padding: 1.25rem; border-top: 1px solid var(--border-color);">
            <div style="font-size: 1.35rem; margin-bottom: 1rem; text-align: center; color: var(--primary-color);"><strong>Total: $<span id="delivery-cart-total">0</span></strong></div>
            <button type="button" onclick="goToConfirmOrder()" style="width: 100%; padding: 1rem; background: var(--gold-gradient); color: var(--dark-bg); border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; margin-bottom: 0.5rem;">Confirmar pedido ‚Üí</button>
            <button type="button" onclick="clearDeliveryCart()" style="width: 100%; padding: 0.75rem; background: #ff4444; color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">Vaciar Carrito</button>
        </div>
    </div>
    <div id="delivery-cart-overlay" onclick="toggleDeliveryCart()" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1500;"></div>

    <script src="/static/alerts.js"></script>
    <script src="/static/address.js"></script>
    <script src="/static/business-images.js"></script>
    <script src="/static/product-images.js"></script>
    <script src="/static/delivery.js"></script>
    <script>
        function toggleDeliveryCart() {
            var sidebar = document.getElementById('delivery-cart-sidebar');
            var overlay = document.getElementById('delivery-cart-overlay');
            if (sidebar.style.right === '0px') { sidebar.style.right = '-380px'; overlay.style.display = 'none'; }
            else { sidebar.style.right = '0px'; overlay.style.display = 'block'; }
        }
        function updateCartBadge() {
            var badge = document.getElementById('delivery-cart-badge');
            if (badge && typeof selectedProducts !== 'undefined') {
                var n = selectedProducts.reduce(function(s, p) { return s + p.quantity; }, 0);
                badge.textContent = n;
                badge.style.display = n > 0 ? 'flex' : 'none';
            }
            if (typeof updateDeliveryCartUI === 'function') updateDeliveryCartUI();
        }
        function updateDeliveryCartUI() {
            var cartItems = document.getElementById('delivery-cart-items');
            var cartEmpty = document.getElementById('delivery-cart-empty');
            var cartFooter = document.getElementById('delivery-cart-footer');
            var cartTotal = document.getElementById('delivery-cart-total');
            if (!cartItems) return;
            if (typeof selectedProducts === 'undefined' || selectedProducts.length === 0) {
                cartEmpty.style.display = 'block';
                cartItems.innerHTML = '';
                cartFooter.style.display = 'none';
            } else {
                cartEmpty.style.display = 'none';
                cartFooter.style.display = 'block';
                var total = selectedProducts.reduce(function(s, p) { return s + p.price * p.quantity; }, 0);
                if (cartTotal) cartTotal.textContent = total.toLocaleString();
                cartItems.innerHTML = '';
                selectedProducts.forEach(function(item, index) {
                    var div = document.createElement('div');
                    div.style.cssText = 'display: flex; flex-wrap: wrap; gap: 0.75rem; padding: 1rem; border-bottom: 1px solid var(--border-color); align-items: center; background: var(--darker-card); border-radius: 10px; margin-bottom: 0.5rem;';
                    var notesEsc = (item.notes || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    div.innerHTML = '<div style="flex:1;min-width:140px;"><div style="font-weight:600;font-size:0.95rem;color:var(--text-dark);">' + item.name.replace(/</g, '&lt;') + '</div>' + (item.notes ? '<div style="font-size:0.85rem;color:var(--text-muted);">Nota: ' + notesEsc + '</div>' : '') + '<div style="color:var(--primary-color);font-weight:700;">$' + (item.price * item.quantity).toLocaleString() + '</div><div style="display:flex;align-items:center;gap:0.5rem;margin-top:0.5rem;"><button type="button" onclick="updateDeliveryQuantity(' + index + ',-1)" style="background:var(--dark-card);border:1px solid var(--border-color);color:var(--primary-color);width:28px;height:28px;border-radius:6px;cursor:pointer;font-weight:bold;">-</button><span style="min-width:24px;text-align:center;font-weight:600;">' + item.quantity + '</span><button type="button" onclick="updateDeliveryQuantity(' + index + ',1)" style="background:var(--dark-card);border:1px solid var(--border-color);color:var(--primary-color);width:28px;height:28px;border-radius:6px;cursor:pointer;font-weight:bold;">+</button></div></div><button type="button" onclick="removeDeliveryProduct(' + index + ')" style="background:#ff4444;color:white;border:none;padding:0.5rem 0.75rem;border-radius:8px;cursor:pointer;font-size:0.85rem;">Eliminar</button>';
                    cartItems.appendChild(div);
                });
            }
        }
        function updateDeliveryQuantity(index, change) {
            if (selectedProducts[index]) {
                selectedProducts[index].quantity += change;
                if (selectedProducts[index].quantity <= 0) selectedProducts.splice(index, 1);
                updateSelectedProducts(); updateOrderTotal(); updateCartBadge();
            }
        }
        function removeDeliveryProduct(index) {
            selectedProducts.splice(index, 1);
            updateSelectedProducts(); updateOrderTotal(); updateCartBadge();
        }
        function clearDeliveryCart() {
            if (confirm('¬øVaciar el carrito?')) {
                selectedProducts = [];
                updateSelectedProducts(); updateOrderTotal(); updateCartBadge();
            }
        }
        function goToConfirmOrder() {
            if (typeof selectedProducts === 'undefined' || selectedProducts.length === 0) {
                if (typeof showAlert !== 'undefined') showAlert('Agrega al menos un producto', 'warning', 'Carrito vac√≠o');
                else alert('Agrega al menos un producto al carrito');
                return;
            }
            if (typeof selectedBusiness === 'undefined' || !selectedBusiness) {
                if (typeof showAlert !== 'undefined') showAlert('Selecciona un negocio', 'warning', 'Negocio requerido');
                else alert('Selecciona un negocio y agrega productos');
                return;
            }
            try {
                sessionStorage.setItem('delivery_cart', JSON.stringify({ business: selectedBusiness, products: selectedProducts.map(function(p) { return { product_id: p.product_id, name: p.name, price: p.price, quantity: p.quantity, notes: p.notes || '' }; }) }));
                toggleDeliveryCart();
                window.location.href = '/order';
            } catch (e) {
                if (typeof showAlert !== 'undefined') showAlert('Error al continuar', 'error', 'Error');
            }
        }
        if (typeof selectedProducts !== 'undefined') updateCartBadge();
    </script>
    <script src="/static/theme.js"></script>
</body>
</html>
