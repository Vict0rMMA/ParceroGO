<!DOCTYPE html>
<html lang="es">
<head>
    <script src="/static/api-shim.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#D4AF37">
    <title>Panel Negocio - Parcero Go</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .panel-container { max-width: 1000px; margin: 2rem auto; padding: 0 1rem; }
        .panel-container h1 { color: #D4AF37; margin-bottom: 0.5rem; }
        .panel-container .sub { color: #b8b8b8; margin-bottom: 1.5rem; }
        .card-panel { background: var(--dark-card); border: 2px solid var(--border-color); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .card-panel h2 { color: #D4AF37; font-size: 1.25rem; margin-bottom: 1rem; }
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-box { background: var(--darker-card); border-radius: 12px; padding: 1rem; text-align: center; border-left: 4px solid #D4AF37; }
        .stat-box .num { font-size: 1.8rem; font-weight: 700; color: #D4AF37; }
        .stat-box .label { font-size: 0.85rem; color: #b8b8b8; }
        .order-row { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding: 1rem; background: var(--darker-card); border-radius: 12px; margin-bottom: 0.75rem; border-left: 4px solid #D4AF37; }
        .order-row.entregado { border-left-color: #00C896; }
        .order-row .info { flex: 1; min-width: 200px; }
        .order-row .info strong { color: #fff; }
        .order-row .info span { color: #b8b8b8; font-size: 0.9rem; }
        .order-row .actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .btn-status { padding: 0.5rem 1rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        .btn-status.preparando { background: #fdcb6e; color: #0a0a0a; }
        .btn-status.en_camino { background: #00C896; color: #fff; }
        .btn-status:disabled { opacity: 0.5; cursor: not-allowed; }
        select { padding: 0.6rem 1rem; background: var(--darker-card); border: 2px solid #2a2a2a; border-radius: 8px; color: var(--text-dark); font-size: 1rem; min-width: 220px; }
    </style>
</head>
<body>
    <a href="#main" class="skip-link">Saltar al contenido</a>
    <nav class="navbar">
        <div class="container">
            <a href="/" class="brand-wrap">
                <img src="/static/logo.png" alt="Parcero Go" class="app-logo" onerror="this.style.display='none';this.nextElementSibling.style.display='inline-block';">
                <span class="brand-text-fallback" style="display:none;">Parcero Go</span>
            </a>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="nav-links">
                    <a href="/">Inicio</a>
                    <a href="/delivery">Delivery</a>
                    <a href="/tracking">Seguimiento</a>
                    <a href="/" class="nav-link-login">Iniciar sesi√≥n</a>
                    <a href="/perfil" class="nav-link-perfil" style="display:none;" aria-hidden="true">Perfil</a>
                    <a href="/repartidor">Repartidor</a>
                    <a href="/panel" class="active">Panel</a>
                </div>
            </div>
        </div>
    </nav>

    <main id="main" class="panel-container">
        <h1>üè™ Panel del Negocio</h1>
        <p class="sub">Gestiona los pedidos de tu negocio</p>

        <div class="card-panel">
            <label for="business-select" style="color: #D4AF37; font-weight: 600; margin-right: 0.5rem;">Mi negocio:</label>
            <select id="business-select">
                <option value="">-- Elegir negocio --</option>
            </select>
            <button type="button" onclick="loadPanelOrders()" style="margin-left: 0.5rem; padding: 0.6rem 1rem; background: var(--gold-gradient); color: var(--dark-bg); border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Actualizar</button>
        </div>

        <div class="card-panel" id="dashboard-section" style="display: none;">
            <h2>üìä Resumen del d√≠a</h2>
            <div class="dashboard-stats" id="dashboard-stats"></div>
        </div>

        <div class="card-panel">
            <h2>üìã Pedidos</h2>
            <div id="panel-orders-list"></div>
        </div>
    </main>

    <script src="/static/address.js"></script>
    <script>if (typeof initNavSession === 'function') initNavSession();</script>
    <script src="/static/theme.js"></script>
    <script>
        let businesses = [];
        let panelOrders = [];

        async function loadBusinesses() {
            try {
                const r = await fetch('/api/delivery/businesses');
                const d = await r.json();
                businesses = d.businesses || [];
                const sel = document.getElementById('business-select');
                sel.innerHTML = '<option value="">-- Elegir negocio --</option>' +
                    businesses.map(b => '<option value="' + b.id + '">' + (b.name || 'Negocio ' + b.id) + '</option>').join('');
                const saved = localStorage.getItem('delivery_panel_business_id');
                if (saved) sel.value = saved;
                loadPanelOrders();
            } catch (e) {
                console.error(e);
            }
        }

        async function loadPanelOrders() {
            const businessId = document.getElementById('business-select').value;
            if (businessId) localStorage.setItem('delivery_panel_business_id', businessId);
            const listEl = document.getElementById('panel-orders-list');
            const dashEl = document.getElementById('dashboard-section');
            const statsEl = document.getElementById('dashboard-stats');

            if (!businessId) {
                listEl.innerHTML = '<p style="color: #b8b8b8;">Selecciona un negocio para ver sus pedidos.</p>';
                dashEl.style.display = 'none';
                return;
            }

            try {
                const r = await fetch('/api/delivery/orders?business_id=' + encodeURIComponent(businessId));
                const d = await r.json();
                panelOrders = d.orders || [];
            } catch (e) {
                panelOrders = [];
            }

            const pending = panelOrders.filter(o => !['entregado', 'cancelado'].includes(o.status));
            const totalRevenue = panelOrders.filter(o => o.status === 'entregado').reduce((s, o) => s + (o.total || 0), 0);

            dashEl.style.display = 'block';
            statsEl.innerHTML = ''
                + '<div class="stat-box"><div class="num">' + panelOrders.length + '</div><div class="label">Total pedidos</div></div>'
                + '<div class="stat-box"><div class="num">' + pending.length + '</div><div class="label">Pendientes</div></div>'
                + '<div class="stat-box"><div class="num">' + (typeof formatCOP === 'function' ? formatCOP(totalRevenue) : '$ ' + totalRevenue.toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 })) + '</div><div class="label">Entregados (total)</div></div>';

            if (panelOrders.length === 0) {
                listEl.innerHTML = '<p style="color: #b8b8b8;">No hay pedidos para este negocio.</p>';
                return;
            }

            listEl.innerHTML = panelOrders.map(o => {
                const status = o.status || 'pendiente';
                const canPreparando = status === 'pendiente';
                const canEnCamino = status === 'preparando';
                let actions = '';
                if (canPreparando) actions += '<button type="button" class="btn-status preparando" onclick="setStatus(' + o.id + ', \'preparando\')">üë®‚Äçüç≥ Preparando</button>';
                if (canEnCamino) actions += '<button type="button" class="btn-status en_camino" onclick="setStatus(' + o.id + ', \'en_camino\')">üöö En camino</button>';
                return '<div class="order-row ' + (status === 'entregado' ? 'entregado' : '') + '">'
                    + '<div class="info"><strong>Pedido #' + o.id + '</strong><br><span>' + (o.customer_name || '') + ' ¬∑ ' + (o.customer_address || '') + '</span><br><span>Total: ' + (typeof formatCOP === 'function' ? formatCOP(o.total || 0) : '$ ' + (o.total || 0).toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 })) + ' ¬∑ ' + status + '</span></div>'
                    + '<div class="actions">' + actions + '</div></div>';
            }).join('');
        }

        async function setStatus(orderId, newStatus) {
            try {
                const r = await fetch('/api/delivery/orders/' + orderId + '/status', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                if (!r.ok) {
                    const err = await r.json().catch(() => ({}));
                    alert(err.detail || 'Error');
                    return;
                }
                loadPanelOrders();
            } catch (e) {
                alert('Error de conexi√≥n');
            }
        }

        document.getElementById('business-select').addEventListener('change', loadPanelOrders);
        loadBusinesses();
    </script>
</body>
</html>
