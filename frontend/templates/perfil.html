<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#D4AF37">
    <title>Mi Perfil - Parcero Go</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .perfil-container { max-width: 600px; margin: 2rem auto; padding: 0 1rem; }
        .perfil-container h1 { color: #D4AF37; margin-bottom: 0.5rem; }
        .perfil-container .sub { color: #b8b8b8; margin-bottom: 1.5rem; }
        .card-p { background: var(--dark-card); border: 2px solid var(--border-color); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .card-p h2 { color: #D4AF37; font-size: 1.2rem; margin-bottom: 1rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.3rem; color: #D4AF37; font-weight: 600; }
        .form-group input { width: 100%; padding: 0.75rem; background: var(--darker-card); border: 2px solid var(--border-color); border-radius: 8px; color: var(--text-dark); }
        .btn-save { padding: 0.6rem 1.2rem; background: var(--gold-gradient); color: var(--dark-bg); border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .addr-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--darker-card); border-radius: 8px; margin-bottom: 0.5rem; }
        .addr-item span { color: var(--text-light); font-size: 0.95rem; }
        .btn-del { padding: 0.3rem 0.6rem; background: #ff4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
        .link-historial { display: inline-block; margin-top: 1rem; padding: 0.75rem 1.5rem; background: var(--gold-gradient); color: var(--dark-bg); border-radius: 10px; font-weight: 600; text-decoration: none; }
        .btn-cerrar-sesion { padding: 0.75rem 1.5rem; background: transparent; color: #e11d48; border: 2px solid #e11d48; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 1rem; }
        .btn-cerrar-sesion:hover { background: rgba(225, 29, 72, 0.1); }
    </style>
</head>
<body>
    <a href="#main" class="skip-link">Saltar al contenido</a>
    <nav class="navbar">
        <div class="container">
            <a href="/" class="brand-wrap">
                <img src="/static/logo.png" alt="Parcero Go" class="app-logo" onerror="this.style.display='none';this.nextElementSibling.style.display='inline-block';">
                <span class="brand-text-fallback" style="display:none;">Parcero Go</span>
            </a>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="nav-links">
                    <a href="/">Inicio</a>
                    <a href="/delivery">Delivery</a>
                    <a href="/tracking">Seguimiento</a>
                    <a href="/" class="nav-link-login">Iniciar sesi贸n</a>
                    <a href="/perfil" class="nav-link-perfil active" style="display:none;" aria-hidden="true">Perfil</a>
                </div>
            </div>
        </div>
    </nav>

    <main id="main" class="perfil-container">
        <h1> Mi Perfil</h1>
        <p class="sub">Datos guardados para pedidos m谩s r谩pidos (solo en este dispositivo)</p>

        <div class="card-p">
            <h2> Mis datos</h2>
            <form id="perfil-form">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="profile-name" placeholder="Tu nombre">
                </div>
                <div class="form-group">
                    <label>Tel茅fono</label>
                    <input type="tel" id="profile-phone" placeholder="+57 300 1234567">
                </div>
                <button type="submit" class="btn-save">Guardar datos</button>
            </form>
        </div>

        <div class="card-p">
            <h2> Mis direcciones</h2>
            <div id="addresses-list"></div>
            <p style="color: #b8b8b8; font-size: 0.9rem;">Las direcciones se guardan al confirmar un pedido marcando &quot;Guardar esta direcci贸n&quot;.</p>
        </div>

        <div class="card-p">
            <h2> Historial de pedidos</h2>
            <p style="color: #b8b8b8; margin-bottom: 0.5rem;">Ver el estado de tus pedidos por tel茅fono.</p>
            <a href="#" id="link-historial" class="link-historial">Ver mis pedidos</a>
        </div>

        <div class="card-p">
            <h2> Sesi贸n</h2>
            <p style="color: #b8b8b8; margin-bottom: 1rem;">Cierra tu sesi贸n en este dispositivo. Volver谩s a ver la pantalla de bienvenida al entrar.</p>
            <button type="button" id="btn-cerrar-sesion" class="btn-cerrar-sesion">Cerrar sesi贸n</button>
        </div>
    </main>

    <script src="/static/theme.js"></script>
    <script src="/static/address.js"></script>
    <script>
        if (typeof isSessionActive === 'function' && !isSessionActive()) {
            window.location.replace('/');
        } else {
        if (typeof initNavSession === 'function') initNavSession();
        const USER_KEY = 'delivery_user';
        const ADDRESSES_KEY = 'delivery_saved_addresses';

        function getUser() {
            try {
                const raw = localStorage.getItem(USER_KEY);
                return raw ? JSON.parse(raw) : {};
            } catch (e) { return {}; }
        }
        function getAddresses() {
            try {
                const raw = localStorage.getItem(ADDRESSES_KEY);
                return raw ? JSON.parse(raw) : [];
            } catch (e) { return []; }
        }

        document.getElementById('perfil-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('profile-name').value.trim();
            const phone = document.getElementById('profile-phone').value.trim();
            localStorage.setItem(USER_KEY, JSON.stringify({ name: name, phone: phone }));
            alert('Datos guardados.');
        });

        function renderAddresses() {
            const list = getAddresses();
            const el = document.getElementById('addresses-list');
            if (list.length === 0) {
                el.innerHTML = '<p style="color: #b8b8b8;">No tienes direcciones guardadas.</p>';
                return;
            }
            el.innerHTML = list.map((a, i) => '<div class="addr-item"><span>' + (a.name || 'Direcci贸n') + ': ' + (a.address || '').substring(0, 50) + '</span><button type="button" class="btn-del" onclick="removeAddress(' + i + ')">Eliminar</button></div>').join('');
        }
        function removeAddress(index) {
            const list = getAddresses();
            list.splice(index, 1);
            localStorage.setItem(ADDRESSES_KEY, JSON.stringify(list));
            renderAddresses();
        }
        window.removeAddress = removeAddress;

        var u = getUser();
        if ((!u.name && !u.phone) && typeof getSessionUserName === 'function' && typeof getSessionUserPhone === 'function') {
            u = { name: getSessionUserName(), phone: getSessionUserPhone() };
            if (u.name || u.phone) localStorage.setItem(USER_KEY, JSON.stringify(u));
        }
        document.getElementById('profile-name').value = u.name || '';
        document.getElementById('profile-phone').value = u.phone || '';
        var link = document.getElementById('link-historial');
        link.href = '/tracking' + (u.phone ? '?phone=' + encodeURIComponent(u.phone) : '');
        if (!u.phone) link.textContent = 'Ir a Seguimiento (ingresa tu tel茅fono all铆)';
        renderAddresses();

        document.getElementById('btn-cerrar-sesion').addEventListener('click', function() {
            if (!confirm('驴Seguro que deseas cerrar sesi贸n?')) return;
            if (typeof clearSession === 'function') clearSession();
            var msg = document.createElement('div');
            msg.setAttribute('role', 'status');
            msg.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:1rem;';
            msg.innerHTML = '<div style="color:#FFD23F;font-size:1.2rem;font-weight:600;">Sesi贸n cerrada correctamente</div><div style="width:40px;height:40px;border:3px solid rgba(255,210,63,0.3);border-top-color:#FFD23F;border-radius:50%;animation:spin .8s linear infinite;"></div>';
            document.body.appendChild(msg);
            var style = document.createElement('style');
            style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
            document.head.appendChild(style);
            setTimeout(function() {
                window.location.replace('/');
            }, 1200);
        });
        }
    </script>
</body>
</html>
